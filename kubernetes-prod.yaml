apiVersion: apps/v1
kind: Deployment
metadata:
    name: forms-app
    namespace: fintech-prod-training
    labels:
        app: forms-app
spec:
    replicas: 1
    selector:
        matchLabels:
            app: forms-app
    template:
        metadata:
            labels:
                app: forms-app
        spec:
            imagePullSecrets:
                - name: fintech-docker-secret
            containers:
                - name: forms-app
                  image: training-docker-registry.fintechchallenge.pl/training/forms-app:image_version_placeholder
                  imagePullPolicy: Always
                  env:
                      - name: API_BASE_PATH
                        value: placeholder
                  ports:
                      - name: web
                        containerPort: 80
                        protocol: TCP
                  resources:
                      limits:
                          cpu: 5m
                          memory: 128Mi
                      requests:
                          cpu: 1m
                          memory: 64Mi
                  livenessProbe:
                      httpGet:
                          path: /
                          port: web
                      initialDelaySeconds: 10
                      periodSeconds: 10
                  readinessProbe:
                      httpGet:
                          path: /
                          port: web
                      initialDelaySeconds: 10
                      periodSeconds: 10
            restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
    name: forms-app
    namespace: fintech-prod-training
    labels:
        app: forms-app
        visualize: 'true'
spec:
    ports:
        - name: web
          port: 80
          protocol: TCP
          targetPort: web
    selector:
        app: forms-app
---

---
# Note: in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.
# To create an encoded user:password pair, the following command can be used:
# htpasswd -nb user password | openssl base64

apiVersion: v1
kind: Secret
metadata:
    name: fintech-prod-training-basic-auth-secret
    namespace: fintech-prod-training

data:
    users: |
        ZXhhbXBsZTokYXByMSROOG1OUFFKTiRJWTVyZnBTenJEZkszTmN1bkhTbWQvCgo=

#encryped username: example, with password: example

---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
    name: fintech-prod-training-basic-auth-middleware
    namespace: fintech-prod-training
spec:
    basicAuth:
        secret: fintech-prod-training-basic-auth-secret
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
    name: forms-app
    namespace: fintech-prod-training
spec:
    entryPoints:
        - websecure
    routes:
        - kind: Rule
          match: Host(`forms-app.training.prod.fintechchallenge.pl`)
          middlewares:
              - name: fintech-prod-training-basic-auth-middleware
                namespace: fintech-prod-training
          services:
              - kind: Service
                name: forms-app
                namespace: fintech-prod-training
                passHostHeader: true
                port: 80
                scheme: http
    tls:
        options:
            namespace: fintech-prod-training
        certResolver: hltech
        domains:
            - main: forms-app.training.prod.fintechchallenge.pl
